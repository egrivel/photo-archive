#!/usr/bin/perl

my $script = __FILE__;
my $localdir = ".";
if ($script =~ s/\/[^\/]*$//) {
  $localdir = $script;
}
push @INC, "$localdir/../inc";

require "photos_util.pm";

put_init();
put_restore_session();

my $start = get_value("start");
my $end = get_value("end");
my $image = get_value("image");
my $do_prev = get_value("prev");

# auto-refresh, must be whole number
my $auto = get_value("auto");
if (!($auto =~ /^\d+$/)) {
  $auto = "";
}

if ($image eq "") {
  $image = $start;
}

if ( ($image =~ /^\d\d\d\d\d\d\d\d$/)
  || ($image =~ /^\w\d\d$/)) {
  # Image is a set; use get next to get the first of the set
  $image = get_next_image($image);
}

my $prev = get_prev_image($image);
my $next = get_next_image($image);

my $is_next_end = 0;
if ($next eq "" || $next eq $image) {
  $is_next_end = 1;
} elsif ($end ne "") {
  # If $end is blank, go all the way to the end
  if ( ($end =~ /^\d\d\d\d\d\d\d\d$/)
    || ($end =~ /^\w\d\d$/)) {
    # End is a set; check against the set name
    my $imageset = "";
    if ($next =~ /^(\w\d\d)\d\d\w?$/) {
      $imageset = $1;
    } elsif ($next =~ /^(\d\d\d\d\d\d\d\d)-\d\d\d\d\d\d\w?$/) {
      $imageset = $1;
    }
    if ($imageset gt $end) {
      $is_next_end = 1;
    }
  } else {
    if ($next gt $end) {
      $is_next_end = 1;
    }
  }
}

if ($is_next_end) {
  # Reached the end; wrap back to the start
  $next = $start;
  if ( ($next =~ /^\d\d\d\d\d\d\d\d$/)
    || ($next =~ /^\w\d\d$/)) {
    # Start is a set; use get next to get the first of the set
    $next = get_next_image($next);
  }
}

my $is_prev_end = 0;
if ($prev eq "" || $prev eq $image) {
  $is_prev_end = 1;
} elsif ($start ne "") {
  # If $start is blank, go all the way to the beginning
  if ($prev lt $start) {
    $is_prev_end = 1;
  }
}

if ($is_prev_end) {
  # Reached the end; wrap back to the end
  $prev = $end;
  if ($prev eq "") {
    $prev = get_prev_image("21991231-235959");
  } elsif ($prev =~ /^\d\d\d\d\d\d\d\d$/) {
    $prev = get_prev_image("$prev-235959z");
  } elsif ($next =~ /^\w\d\d$/) {
    $prev = get_prev_image("${prev}99z");
  }
}

display_img($image, $prev, $next, $start, $end, $auto);
exit(0);

sub display_img {
  my $image = $_[0];
  my $prev = $_[1];
  my $next = $_[2];
  my $start = $_[3];
  my $end = $_[4];
  my $auto = $_[5];

  # Default size to "m5", which is about 1920x1080, which should be a good
  # default for most phone, tablet and laptop displays
  my $size = "m5";

  my $image_url = "phimg?$size=$image&orientation=landscape";

  my $content = "";

  # Build the header elements. This contains custom styles and the script to
  # handle the body click.
  my $header = "";

  $header .= "<style>\n";
  $header .= "html {\n";
  $header .= "  height: 100%;\n";
  $header .= "}\n";
  if (pdb_get_type($image) ne "MOV") {
    $header .= "body.slideshow {\n";
    $header .= "  background-image: url('$image_url');\n";
    $header .= "}\n";
  }
  $header .= "div.prevClick {\n";
  $header .= "  position: absolute;\n";
  $header .= "  top: 0;\n";
  $header .= "  left: 0;\n";
  $header .= "  width: 39%;\n";
  $header .= "  height: 100%;\n";
  $header .= "  cursor: pointer;\n";
  $header .= "}\n";
  $header .= "div.nextClick {\n";
  $header .= "  position: absolute;\n";
  $header .= "  top: 0;\n";
  $header .= "  right: 0;\n";
  $header .= "  width: 59%;\n";
  $header .= "  height: 100%;\n";
  $header .= "  cursor: pointer;\n";
  $header .= "}\n";
  $header .= "</style>\n";

  my $prev_url = "phslideshow?image=$prev";
  $prev_url .= "&start=$start" if ($start ne "");
  $prev_url .= "&end=$end" if ($end ne "");
  $prev_url .= "&auto=$auto" if ($auto ne "");

  my $next_url = "phslideshow?image=$next";
  $next_url .= "&start=$start" if ($start ne "");
  $next_url .= "&end=$end" if ($end ne "");
  $next_url .= "&auto=$auto" if ($auto ne "");

  $header .= "<script>\n";
  $header .= "function goNext() {\n";
  $header .= "  event.preventDefault();\n";
  $header .= "  location='$next_url';\n";
  $header .= "  return false;\n";
  $header .= "};\n";
  $header .= "function goPrev(event) {\n";
  $header .= "  event.preventDefault();\n";
  $header .= "  location='$prev_url';\n";
  $header .= "  return false;\n";
  $header .= "};\n";
  $header .= "</script>\n";

  pht_add_header($header);

  if ($auto ne "" && $auto > 0) {
    pht_set_refresh("$auto; url='$next_url'");
  }

  if (pdb_get_type($image) eq "MOV") {
    $content =
        "<video width='80%' height='80%' "
      . "controls poster='phimg?mov=$image'>"
      . "<source src='phmov?mov=$image' type='video/mp4'/>"
      . "</video>";
  }

  pht_page_start(0, 0);

  print "<body class='slideshow'>\n";
  print "<div class='prevClick' onclick='goPrev(event)'>&nbsp;</div>\n";
  print "<div class='nextClick' onclick='goNext(event)'>&nbsp;</div>\n";
  print $content;

  # Pre-load the next image, to make loading faster
  print "<img src='./phimg?$size=$next&orientation=landscape' width='1' ";
  print " height='1' border='0'>\n";

  pht_page_end(0);
}

sub get_value {
  my $varname = $_[0];
  my $default = $_[1];
  if (!defined($default)) {
    $default = "";
  }

  my $value = $default;

  if (parg_exists($varname)) {
    $value = parg_get($varname);
    # Note: using value from session is disabled for now, it doesn't work
    # through the proxy
    # # Specific value specified; save it in the session
    # pses_set($varname, $value);
    # } else {
    #   # No value specified; get one from the session
    #   my $temp = pses_get($varname);
    #   if ($temp ne "") {
    #     $value = $temp;
    #   }
  }
  return $value;
}

sub set_value {
  my $varname = $_[0];
  my $value = $_[1];
  pses_set($varname, $value);
  return $value;
}

sub get_next_image {
  my $imageid = $_[0];

  my $user = $PUSR_GUEST_ACCOUNT;

  # Set the filters appropriately
  my $types = get_types($user);
  my $min_quality = get_value("min_quality");
  if ($min_quality eq "") {
    $min_quality = get_quality($user);
  }

  # Determine the next image

  my $class = put_get_class($imageid);

  my $iter = pdb_iter_new($imageid);
  pdb_iter_filter_category($iter, $types);
  pdb_iter_filter_min_quality($iter, $min_quality);

  my $next = pdb_iter_next($iter);
  if ($next eq $imageid) {
    $next = pdb_iter_next($iter);
  }
  pdb_iter_done($iter);

  if (put_get_class($next) ne $class) {
    # different class, so do not walk over into it
    $next = "";
  }
  return $next;
}

sub get_prev_image {
  my $imageid = $_[0];

  my $user = $PUSR_GUEST_ACCOUNT;

  # Set the filters appropriately
  my $types = get_types($user);
  my $min_quality = get_value("min_quality");
  if ($min_quality eq "") {
    $min_quality = get_quality($user);
  }

  # Determine the previous image

  my $class = put_get_class($imageid);

  my $iter = pdb_iter_new($imageid);
  pdb_iter_filter_category($iter, $types);
  pdb_iter_filter_min_quality($iter, $min_quality);

  my $prev = pdb_iter_previous($iter);
  if ($prev eq $imageid) {
    $prev = pdb_iter_previous($iter);
  }
  pdb_iter_done($iter);

  if (put_get_class($next) ne $class) {
    # different class, so do not walk over into it
    $prev = "";
  }
  return $prev;
}

sub get_types {
  my $effective_user = $_[0];

  if ($effective_user ne "") {
    # Use the edit function to retrieve the settings for the
    # "random" user
    pusr_load($effective_user);
  }

  my $types = put_types();

  return $types;
}

sub get_quality {
  my $effective_user = $_[0];

  if ($effective_user ne "") {
    # Use the edit function to retrieve the settings for the
    # "random" user
    pusr_load($effective_user);
  }

  my $quality = put_quality();

  return $quality;
}
